<!DOCTYPE html>
<html lang="en">
<head>
    <title>Set Pin</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{
            box-sizing: border-box;
            font-family: "Inter";
        }
        
        .hide-scrollbar {
	    width: 100%;
		height: 100vh;
        -ms-overflow-style: none;  /* IE and Edge */
		overflow-y: scroll;
		scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
            width: 0px;
            height: 0px;
        }
        .hero-img {
            text-align: center;
        }
        .main-section {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 15px;
            background: white;
        }

        .card-section {
            width: 35%;
            height: auto;
            background: #fff;
            border-radius: 10px;
        }

        .card-pic {
            will-change: transform;
            transform: perspective(300px) rotateX(0deg) rotateY(0deg);
            width: 316px;
        }
        
        .input-div {
            position: relative;
            width: 100%;
            z-index: 1;
            margin: 32px 0px;
        }
        .input-text-ref {
            font-size: 16px;
            color: #55536B;
            margin: 4px 2px 6px 2px;
        }

        .input-01 {
            font-family: "Inter";
            font-size: 15px;
            line-height: 1.5;
            color: #666666;
            display: block;
            border: none;
            width: 100%;
            background: #F3F3F5;
            height: 50px;
            border-radius: 8px;
            padding: 0 25px 0 25px;
        }

        .input-02 {
            font-family: "Inter";
            font-size: 15px;
            line-height: 1.5;
            color: #666666;
            display: inline;
            text-align: center;
            border: none;
            width: 10%;
            background: #e6e6e6;
            height: 50px;
            border-radius: 7px;
            padding: 0px 5px 0 5px;
        }

        .input-wd {
            width: 10px;
            display: inline;
        }

        .input-btn-div {
            width: 100%;
            display: -webkit-box;
            display: -webkit-flex;
            display: -moz-box;
            display: -ms-flexbox;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding-top: 20px;
        }

        .input-btn {
            font-family:"Inter";
            font-size: 15px;
            line-height: 1.5;
            color: #fff;
            text-transform: uppercase;
            width: 100%;
            height: 50px;
            border-radius: 8px;
            border: none;
            background: #2A9EDA;
            display: block;
            justify-content: center;
            align-items: center;
            padding: 0 25px;
            transition: all 0.4s;
        }

        .img-footer {
            text-align: center;
            padding: 25px;
        }

        .img-footer img {
            width: 50px;
        }

        .capitalize {
            text-transform: capitalize;
            padding: 20px 110px;
            background-color: #8555c8;
            font-size: 17px;
            color: white;
            height: 25px;
            text-align: center;
            margin-bottom: 25px;
        }

        .input-pd {
            padding: 0px 50px;
        }
        .error-text {
            color: red;
            font-size: 10px;
            margin-top: 5px;
        }
        @media only screen and (max-width: 768px) {
            .card-section {
                width: 100%;
                height: auto;
                background: #fff;
                border-radius: 10px;
            }
        }
    </style>
</head>
<body>
<div class="main-section hide-scrollbar">
    <div class="card-section">
	    <button onclick="pp()">HELLO CLICK ME</button>
        <div class="hero-img">
            <img src="https://s3.ap-south-1.amazonaws.com/public.refyne.co.in/images/app/two-side-card.svg" alt="card icon" width="100%">
        </div>
        <div class="details-section" id="details-section">
            <form id="myForm" action="">
                <div class="input-div">
                    <div class="input-text-ref">Enter last 6 digit of your card number</div>
                    <input class="input-01" type="text" id="card_number" name="card_number"
                        onkeypress="return isNumber(event)" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1');" maxlength="6">
                        <div class="error-text" id="card-number-error" style="display: none;">Invailid 6 digit card number</div>
                
                </div>
                <div class="input-div">
                    <div class="input-text-ref">Enter the expiry date MONTH/YYYY</div>
                    <input class="input-01 card" type="month" id="expiry_date" name="expiry_date"
                        autocomplete="off" data-on="Enabled" data-off="Disabled">
                    <div class="error-text" id="expiry-date-error" style="display: none;">Invailid expiry date</div>
                </div>
                <div class="input-btn-div">
                    <input class="input-btn" type="button" onclick="details()" value="Verify card details">
                </div>
            </form>
        </div>
        <div class="pin-section" id="pin-section" style="display: none;">
            <form id="myForm" action="">
            
                <div class="input-div"> 
                    <div class="input-text-ref">Enter OTP</div>
                    <input class="input-01" type="text" id="otp" name="otp" onkeypress="return isNumber(event)" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1');">
                    <div class="error-text" id="otp-error" style="display: none;">Invailid OTP</div>
                </div>
                <div class="input-div">
                    <div class="input-text-ref">Date of Birth (DD/MM/YYYY)</div>
                    <input class="input-01 card" type="date" id="dob" name="dob"
                           placeholder="Enter date of Birth DD/MM/YY" autocomplete="off" data-on="Enabled" data-off="Disabled">
                    <div class="error-text" id="dob-error" style="display: none;">Invailid date</div>
                </div>
                <div class="input-div">
                    <div class="input-text-ref">Enter a new PIN</div>
                    <input class="input-01" type="password" id="newPin" name="new_pin" onkeypress="return isNumber(event)" maxlength="4" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1');">
                    <div class="error-text" id="pin-error" style="display: none;">PIN error</div>
                
                </div>
                <div class="input-div">
                    <div class="input-text-ref">Confirm the new PIN</div>
                    <input class="input-01" type="password" id="confirmPin" name="confirm_pin" onkeypress="return isNumber(event)" maxlength="4"
                         oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1');">
                         <div class="error-text" id="repin-error" style="display: none;">Confirm PIN error</div>
                         <div class="error-text" id="repin-mismatch-error" style="display: none;">PIN mismatch</div>
                    </div>
                <div class="input-btn-div">
                    <input class="input-btn" type="button" onclick="setPinWithOtp()" value="Set PIN">
                </div>
            </form>
        </div>
    </div>
</div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="https://cdn.rawgit.com/CryptoStore/crypto-js/3.1.2/build/rollups/aes.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
<script>
    let bob = null;
    let aliceKeyImported = null;
    let cek = null;
    let sharedSecretHex = null;
    
    function informParentToCloseWindow() {
        window.parent.postMessage("CLOSE_PAYMENT_IFRAME", '*');
    }
    function pp() {
	alert("INSIDE");
	window.testIframeCall("ok")
	window.webToMobileMessageHandler("SANDIP PAUL")    

     }

    window.crypto.subtle.generateKey(
            {
                name: 'ECDH',
                namedCurve: 'P-256'
            },
            false, // no need to make Bob's private key exportable
            ['deriveKey', 'deriveBits'])
            .then(bobKey => {
                bob = bobKey;
                // export Bob's public key
                return window.crypto.subtle.exportKey(
                        'raw', bobKey.publicKey)
            }).then(bobPublicKeyExported => {
        const bobPublicKeyHex = buf2Hex(bobPublicKeyExported);
        // display and send Bob's public key to Alice
        console.log(`Bob's publicKey: ${bobPublicKeyHex}`);
        var publicKeyFinal = {};
        publicKeyFinal.publicKey = bobPublicKeyHex;
        publicKeyFinal.setPin = true;

        // aliceKeyImported = hex2Arr("048d049b2efe6577ebea5fb4b34e50273e73b41e3e826ab18cb08e966f5abe9030929be43195270bf139b9b16a00729e6fb1db5eb0169be8935e00275aa00521c7");
        cek = "7ec00e36f83980c23f68ff0f9d399cebb18c6218f162e0c04097c70cd0e09802";
        $.ajax({
            url: '/url/fetchPublicKeyAndCek',
            type: 'POST',
            data: publicKeyFinal,
            async: false,
            success: function (publicKey, status) {
                aliceKeyImported = hex2Arr(publicKey[0]);
                if (publicKey[1] !== null) {
                    cek = publicKey[1];
                    console.log("SCK" + cek);
                }
            }
        });
        return window.crypto.subtle.importKey(
                'raw',
                aliceKeyImported,
                {
                    name: 'ECDH',
                    namedCurve: 'P-256'
                },
                true,
                [])
    }).then(aliceKeyImported => {
        // use Alice's imported public key and
        // Bob's private key to compute the shared secret
        return window.crypto.subtle.deriveBits({
                name: 'ECDH',
                namedCurve: 'P-256',
                public: aliceKeyImported
            },
            bob.privateKey,
            256)
    }).then(sharedSecret => {
        sharedSecretHex = buf2Hex(sharedSecret);
        console.log(`sharedSecret: ${sharedSecretHex}`)
    }).catch(err => {
        console.log(err)
    });

    const hex2Arr = str => {
        if (!str) {
            return new Uint8Array()
        }
        const arr = [];
        for (let i = 0, len = str.length; i < len; i += 2) {
            arr.push(parseInt(str.substr(i, 2), 16))
        }
        return new Uint8Array(arr)
    };

    const buf2Hex = buf => {
        return Array.from(new Uint8Array(buf))
                .map(x => ('00' + x.toString(16)).slice(-2))
                .join('')
    };
    let pinshow = false;
    var response = '';
    var randomUrlToken = location.href;
    var matchToken = /\=\|([^>]*)/i;
    var randomToken = randomUrlToken.match(matchToken);

    function details() {
        var card_number = document.getElementById("card_number").value;
        var card_number_error_element = document.getElementById("card-number-error")
        var expiry_date_error_element = document.getElementById("expiry-date-error")
        card_number_error_element.style.display = "none";
        expiry_date_error_element.style.display = "none";

        var expiry_date = $("#expiry_date").val();
        if(expiry_date === "" || expiry_date === null){
            expiry_date_error_element.style.display = "block"
        }
        expiry_date = moment(expiry_date).format("MMYY");

        var verifyCardDetails = {};
        verifyCardDetails.cardNoLastsix = card_number;
        verifyCardDetails.expiryDate = expiry_date;
        console.log("Expiry Date :: " + expiry_date );
console.log(window.location)
        if(card_number ==="" || card_number===null){
            card_number_error_element.style.display = "block"
        }else{
		console.log(window.location, "1")
            var ctObj ={};
            ctObj.encryptedReq = CryptoJS.AES.encrypt(JSON.stringify(verifyCardDetails), sharedSecretHex).toString();
	    
            $.ajax({
                url: '/url/confirmCardDetails',
                type: 'POST',
                headers: {'randomToken': randomToken[1]},
                data: ctObj,
                success: function (res) {
                    response = res;
                    console.log(JSON.stringify(response));
                    console.log("Card Validation Success");
                    alert("Card Validation Success. Please Enter the Otp and Pin");
                    pinshow = true;
                    if (pinshow) {
                        document.getElementById("details-section").style.display = "none";
                        document.getElementById("pin-section").style.display = "block";
                    } else {
                        document.getElementById("details-section").style.display = "block";
                        document.getElementById("pin-section").style.display = "none";
                    }
                },
                error: function (XMLHttpRequest) {
                    alert(XMLHttpRequest.responseText);
                }
            });
        }
    }

    function setPinWithOtp() {

        var otp = document.getElementById("otp").value;
        // var dob = document.getElementById("dob").value;
        var dob = $("#dob").val();
        dob = moment(dob).format("DDMMYYYY");

        var newPin = document.getElementById("newPin").value;
        var confirmPin = document.getElementById("confirmPin").value;

        var decryptResponse = JSON.parse(CryptoJS.enc.Utf8.stringify(CryptoJS.AES.decrypt(response[0], sharedSecretHex)));
        var pinDecry = CryptoJS.enc.Utf8.stringify(CryptoJS.AES.decrypt(response[1], sharedSecretHex));
        var encrpytedPin = CryptoJS.AES.encrypt(JSON.stringify(newPin), pinDecry).toString();

        var otp_error_element = document.getElementById("otp-error");
        var dob_error_element = document.getElementById("dob-error");
        var pin_error_element = document.getElementById("pin-error");
        var repin_error_element = document.getElementById("repin-error");
        var repin_error_mismatch_element = document.getElementById("repin-mismatch-error");

        otp_error_element.style.display = "none";
        dob_error_element.style.display = "none";
        pin_error_element.style.display = "none";
        repin_error_element.style.display = "none";
        repin_error_mismatch_element.style.display = "none";

        if(otp ==="" || otp===null){
            otp_error_element.style.display = "block";
        }else if(dob ==="" || dob===null || dob === "Invalid date"){
            dob_error_element.style.display = "block";
        }else if(newPin ==="" || newPin===null){
            pin_error_element.style.display = "block";
        }else if(confirmPin ==="" || confirmPin===null){
            repin_error_element.style.display = "block";
        }else if(newPin !== confirmPin){
            repin_error_mismatch_element.style.display = "block";
        } else {
            console.log("ENCRYPTRESPONSE : " + encrpytedPin);
            document.getElementById("newPin").value = encrpytedPin;
            document.getElementById("confirmPin").value = encrpytedPin;
            console.log("DECRYPTRESPONSE : " + decryptResponse);
            var entityId = JSON.parse(decryptResponse.result.entityId);
            var kitNo = JSON.parse(decryptResponse.result.kitNo);
            var expDate = JSON.parse(decryptResponse.result.expiryDate);
            var contactNo = JSON.stringify(decryptResponse.result.contactNo);
            var verifyOtp = {};
            verifyOtp.entityId = entityId;
            verifyOtp.kitNo = kitNo;
            verifyOtp.expiryDate = expDate;
            verifyOtp.otp = otp;
            verifyOtp.pin = encrpytedPin;
            verifyOtp.dob = dob;
            verifyOtp.contactNo = contactNo.replace(/"/g, "");

            var encrpytValidatOtpData ={};
            encrpytValidatOtpData.encryptedReq = CryptoJS.AES.encrypt(JSON.stringify(verifyOtp), sharedSecretHex).toString();
            console.log(verifyOtp);
            $.ajax({
                url: '/url/validateOtpAndSetPin',
                type: 'POST',
                headers: {'randomToken': randomToken[1]},
                data: encrpytValidatOtpData,
                success: function (res) {
                    response = JSON.stringify(res);
                    console.log("Response" + JSON.stringify(res));
                    informParentToCloseWindow()
                },
                error: function (XMLHttpRequest) {
                    alert(XMLHttpRequest.responseText);
                }
            });
        }
    }

    function isNumber(evt) {
        evt = (evt) ? evt : window.event;
        var charCode = (evt.which) ? evt.which : evt.keyCode;
        if (charCode > 31 && (charCode < 48 || charCode > 57)) {
            return false;
        }
        return true;
    }

</script>
</html>
